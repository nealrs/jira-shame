<div class="digest-page" id="digest-content">
  <header class="digest-header">
    <h1>Last Sprint Retro</h1>
    <div class="digest-meta">
      <p class="digest-sprint">Sprint: <strong><%= digest.sprintName || digest.periodLabel %></strong> (most recently ended)</p>
      <p class="generated-at">Generated <%= digest.generatedAt %></p>
    </div>
  </header>

  <section class="digest-section digest-section-collapsible digest-callouts" id="section-retro-notes" data-section="retro-notes">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="retro-notes">Retro notes</button></h2>
    <div class="digest-section-body retro-notes-stats">
      <% if (digest.retroNotes && digest.retroNotes.length > 0) { %>
        <p class="retro-coaching-label">Focus</p>
        <ul class="retro-notes-list">
          <% digest.retroNotes.forEach(c => { %>
            <li class="retro-note-item"><%= c.message %><% if (c.linkHref && c.linkLabel) { %> <a href="<%= c.linkHref %>" class="retro-note-link" aria-label="<%= c.linkLabel %>" title="<%= c.linkLabel %>"><span class="retro-note-link-icon" aria-hidden="true">↗</span></a><% } %></li>
          <% }); %>
        </ul>
      <% } %>
      <% if (digest.creep) { %>
        <div class="retro-creep-layout">
          <div class="retro-creep-stats">
            <% if (digest.creepTakeaway) { %>
              <p class="digest-stats creep-takeaway"><%= digest.creepTakeaway %></p>
            <% } %>
            <dl class="digest-scope-stats">
              <dt>Started with</dt><dd><%= digest.creep.startedWith %></dd>
              <dt>Ended with</dt><dd><%= digest.creep.endedWith %></dd>
              <dt>Creep (net)</dt><dd><%= digest.creep.creepNet >= 0 ? '+' : '' %><%= digest.creep.creepNet %> (<%= digest.creep.addedCount %> added, <%= digest.creep.removedCount %> removed)</dd>
              <dt>% complete (of ended)</dt><dd><%= digest.creep.pctCompleteEnded %>%</dd>
              <dt>% complete (of started)</dt><dd><%= digest.creep.pctCompleteStarted %>%</dd>
            </dl>
            <% if (digest.burnupChart && digest.burnupChart.daily && digest.burnupChart.daily.length > 0) { %>
              <% const bd = digest.burnupChart; const daily = bd.daily; %>
              <p class="creep-bar-summary retro-creep-summary">Started with <strong><%= bd.startedWith != null ? bd.startedWith : daily[0].scope %></strong> tickets; ended with <strong><%= bd.endedWith != null ? bd.endedWith : daily[daily.length - 1].scope %></strong> in scope (creep). <strong><%= (typeof digest.creep !== 'undefined' && digest.creep && digest.creep.completed != null) ? digest.creep.completed : daily[daily.length - 1].completed %></strong> completed by end of sprint.<% if (bd.source === 'reconstructed') { %> (Chart built from resolution dates and sprint changes.)<% } %></p>
            <% } %>
          </div>
          <% if (digest.burnupChart && digest.burnupChart.daily && digest.burnupChart.daily.length > 0) { %>
          <div class="retro-creep-chart burnup-chart-wrap">
            <p class="creep-bar-label">Sprint Progress</p>
          <% const bd = digest.burnupChart; const daily = bd.daily; const lastIdx = daily.length - 1; const maxScope = Math.max(...daily.map(d => d.scope), 1); const maxCompleted = Math.max(...daily.map(d => d.completed), 1); const maxRemaining = Math.max(...daily.map(d => (d.remaining != null ? d.remaining : Math.max(0, (d.scope || 0) - (d.completed || 0)))), 0); const maxYRaw = Math.max(maxScope, maxCompleted, maxRemaining, 1); const maxY = Math.ceil(maxYRaw / 5) * 5; const tickStep = 5; const numTicks = maxY / tickStep; const w = 720; const h = 300; const pad = { t: 24, r: 24, b: 32, l: 40 }; const x0 = pad.l; const x1 = w - pad.r; const y0 = pad.t; const y1 = h - pad.b; %>
          <svg class="burnup-svg" viewBox="0 0 <%= w %> <%= h %>" xmlns="http://www.w3.org/2000/svg" aria-label="Burnup and burndown: scope, completed, and remaining tickets by day">
            <defs>
              <linearGradient id="burnup-scope-fill" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#1e5f74" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#1e5f74" stop-opacity="0.06"/>
              </linearGradient>
              <linearGradient id="burnup-done-fill" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#047857" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#047857" stop-opacity="0.08"/>
              </linearGradient>
            </defs>
            <g class="burnup-grid">
              <% for (let i = 0; i <= numTicks; i++) { const y = y0 + (y1 - y0) * (i / numTicks); %>
              <line x1="<%= x0 %>" y1="<%= y %>" x2="<%= x1 %>" y2="<%= y %>" stroke="var(--border, #EBECF0)" stroke-dasharray="4 2" stroke-width="0.5"/>
              <% } %>
              <% daily.forEach((d, i) => { if (i === 0 || i === daily.length - 1) { const x = lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0; %>
              <line x1="<%= x %>" y1="<%= y0 %>" x2="<%= x %>" y2="<%= y1 %>" stroke="var(--border, #EBECF0)" stroke-dasharray="4 2" stroke-width="0.5"/>
              <% } }); %>
            </g>
            <g class="burnup-scope">
              <% const scopePath = daily.map((d, i) => (i === 0 ? 'M' : 'L') + ' ' + (lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0) + ' ' + (y1 - (d.scope / maxY) * (y1 - y0))).join(' '); %>
              <path d="<%= scopePath %> L <%= x1 %> <%= y1 %> L <%= x0 %> <%= y1 %> Z" fill="url(#burnup-scope-fill)" stroke="none"/>
              <path d="<%= scopePath %>" fill="none" stroke="#1e5f74" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </g>
            <g class="burnup-completed">
              <% const donePath = daily.map((d, i) => (i === 0 ? 'M' : 'L') + ' ' + (lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0) + ' ' + (y1 - (d.completed / maxY) * (y1 - y0))).join(' '); %>
              <path d="<%= donePath %> L <%= x1 %> <%= y1 %> L <%= x0 %> <%= y1 %> Z" fill="url(#burnup-done-fill)" stroke="none"/>
              <path d="<%= donePath %>" fill="none" stroke="#047857" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </g>
            <g class="burnup-burndown">
              <% const remainingPath = daily.map((d, i) => { const rem = d.remaining != null ? d.remaining : Math.max(0, (d.scope || 0) - (d.completed || 0)); return (i === 0 ? 'M' : 'L') + ' ' + (lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0) + ' ' + (y1 - (rem / maxY) * (y1 - y0)); }).join(' '); %>
              <path d="<%= remainingPath %>" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="5 4"/>
            </g>
            <g class="burnup-labels">
              <text x="<%= x0 + (x1 - x0) / 2 %>" y="<%= h - 6 %>" text-anchor="middle" class="burnup-axis-label">Day</text>
              <% for (let i = 0; i <= numTicks; i++) { const y = y0 + (y1 - y0) * (i / numTicks); const val = maxY - i * tickStep; %>
              <text x="<%= x0 - 8 %>" y="<%= y + 4 %>" text-anchor="end" class="burnup-axis-label burnup-y-tick"><%= val %></text>
              <% } %>
              <% daily.forEach((d, i) => { if (i === 0 || i === daily.length - 1 || daily.length <= 8) { const x = lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0; %>
              <text x="<%= x %>" y="<%= y1 + 12 %>" text-anchor="middle" class="burnup-tick-label"><%= d.label || d.date %></text>
              <% } }); %>
            </g>
            <g class="burnup-points">
              <% const dayWidth = lastIdx > 0 ? Math.max((x1 - x0) / daily.length, 8) : 20; daily.forEach((d, i) => { const cx = lastIdx > 0 ? x0 + (i / lastIdx) * (x1 - x0) : x0; const scopeY = y1 - (d.scope / maxY) * (y1 - y0); const completedY = y1 - (d.completed / maxY) * (y1 - y0); const rem = d.remaining != null ? d.remaining : Math.max(0, (d.scope || 0) - (d.completed || 0)); const remainingY = y1 - (rem / maxY) * (y1 - y0); const tip = (d.label || d.date) + ': Scope ' + d.scope + ', Completed ' + d.completed + ', Remaining ' + rem; %>
              <g class="burnup-day-hover" data-day="<%= (d.label || d.date).toString().replace(/"/g, '&quot;') %>" data-scope="<%= d.scope %>" data-completed="<%= d.completed %>" data-remaining="<%= rem %>">
                <title><%= tip %></title>
                <rect class="burnup-day-hit" x="<%= cx - dayWidth / 2 %>" y="<%= y0 %>" width="<%= dayWidth %>" height="<%= y1 - y0 %>" fill="transparent" aria-hidden="true"/>
                <circle class="burnup-dot burnup-dot-scope" cx="<%= cx %>" cy="<%= scopeY %>" r="3.5" fill="#1e5f74" stroke="#fff" stroke-width="1"/>
                <circle class="burnup-dot burnup-dot-completed" cx="<%= cx %>" cy="<%= completedY %>" r="3.5" fill="#047857" stroke="#fff" stroke-width="1"/>
                <circle class="burnup-dot burnup-dot-remaining" cx="<%= cx %>" cy="<%= remainingY %>" r="3.5" fill="#b91c1c" stroke="#fff" stroke-width="1"/>
              </g>
              <% }); %>
            </g>
          </svg>
          <div class="burnup-tooltip" id="burnup-tooltip" role="tooltip" aria-hidden="true"></div>
          <div class="burnup-legend" role="list" aria-label="Chart legend">
            <span class="burnup-legend-item"><span class="burnup-legend-swatch burnup-legend-scope" aria-hidden="true"></span>Scope</span>
            <span class="burnup-legend-item"><span class="burnup-legend-swatch burnup-legend-completed" aria-hidden="true"></span>Completed</span>
            <span class="burnup-legend-item"><span class="burnup-legend-swatch burnup-legend-remaining" aria-hidden="true"></span>Remaining</span>
          </div>
          </div>
        <% } %>
        </div>
      <% } %>
    </div>
  </section>

  <% if (digest.sweat && digest.sweat.rows && digest.sweat.rows.length > 0) { %>
  <section class="digest-section digest-section-collapsible" id="section-sweat" data-section="sweat">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="sweat">Sweat (assigned vs completed)</button></h2>
    <div class="digest-section-body">
    <table class="digest-table">
      <thead><tr><th class="sortable">Assignee <span class="sort-indicator"></span></th><th class="sortable sort-numeric">Assigned <span class="sort-indicator"></span></th><th class="sortable sort-numeric">Completed <span class="sort-indicator"></span></th><th class="sortable sort-numeric">Gap % <span class="sort-indicator"></span></th></tr></thead>
      <tbody>
        <% digest.sweat.rows.forEach(r => { %>
          <tr class="<%= r.gapPct >= (digest.coachingSweatGapPercent != null ? digest.coachingSweatGapPercent : 30) ? 'sweat-row-high-gap' : '' %>">
            <td class="digest-cell-avatar-name"><% if (r.avatarUrl) { %><img class="digest-avatar" src="<%= r.avatarUrl %>" alt="" width="20" height="20" /><% } %><%= r.assigneeShort %></td>
            <td data-sort-numeric="<%= r.assigned %>"><%= r.assigned %></td>
            <td data-sort-numeric="<%= r.completed %>"><%= r.completed %></td>
            <td data-sort-numeric="<%= r.gapPct %>"><%= r.gapPct %>%</td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    </div>
  </section>
  <% } %>

  <section class="digest-section digest-section-collapsible" id="section-high-priority" data-section="high-priority">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="high-priority">High priority (<%= digest.highPriority ? digest.highPriority.length : 0 %>)</button></h2>
    <div class="digest-section-body">
    <% if (digest.highPriority && digest.highPriority.length > 0) { %>
    <table class="digest-table">
      <thead><tr><th class="sortable">Key <span class="sort-indicator"></span></th><th class="sortable">Assignee <span class="sort-indicator"></span></th><th class="sortable">Summary <span class="sort-indicator"></span></th><th class="sortable">Status <span class="sort-indicator"></span></th><th class="sortable">Issue type <span class="sort-indicator"></span></th></tr></thead>
      <tbody>
        <% digest.highPriority.forEach(i => { %>
          <tr>
            <td class="digest-cell-key"><a href="<%= i.link %>" target="_blank"><%= i.key %></a></td>
            <td class="digest-cell-avatar-name"><% if (i.avatarUrl) { %><img class="digest-avatar" src="<%= i.avatarUrl %>" alt="" width="20" height="20" /><% } %><%= i.assigneeShort %></td>
            <td><%= i.summary %></td>
            <td><%= i.status %></td>
            <td><span class="issue-type-badge <%= (i.issueType || '').toLowerCase().replace(/-/g, '') %>"><%= i.issueType %></span></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <% } else { %>
    <p class="digest-empty">None in this sprint.</p>
    <% } %>
    </div>
  </section>

  <section class="digest-section digest-section-collapsible" id="section-stuck" data-section="stuck">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="stuck">Stuck (7+ days in status) (<%= digest.stuck ? digest.stuck.length : 0 %>)</button></h2>
    <div class="digest-section-body">
    <p class="digest-stats digest-stats-padded digest-stuck-framing">Tickets below have been in the same status 7+ days. Consider: break down? blocked? remove?</p>
    <% if (digest.stuck && digest.stuck.length > 0) { %>
    <table class="digest-table digest-table-stuck" id="stuck-table">
      <thead>
        <tr>
          <th class="sortable">Key <span class="sort-indicator"></span></th>
          <th class="sortable">Assignee <span class="sort-indicator"></span></th>
          <th class="sortable">Summary <span class="sort-indicator"></span></th>
          <th class="sortable">Status <span class="sort-indicator"></span></th>
          <th class="sortable">Issue type <span class="sort-indicator"></span></th>
          <th class="sortable sort-numeric sort-initial-desc">Days <span class="sort-indicator"></span></th>
          <th class="sortable">Priority <span class="sort-indicator"></span></th>
        </tr>
      </thead>
      <tbody>
        <% digest.stuck.forEach(i => { %>
          <tr>
            <td class="digest-cell-key"><a href="<%= i.link %>" target="_blank"><%= i.key %></a></td>
            <td class="digest-cell-avatar-name"><% if (i.avatarUrl) { %><img class="digest-avatar" src="<%= i.avatarUrl %>" alt="" width="20" height="20" /><% } %><%= i.assigneeShort %></td>
            <td><%= i.summary %></td>
            <td><%= i.status %></td>
            <td><span class="issue-type-badge <%= (i.issueType || '').toLowerCase().replace(/-/g, '') %>"><%= i.issueType %></span></td>
            <td data-sort-numeric="<%= i.daysInStatus %>"><span class="stuck-days-badge <%= i.badgeClass || '' %>"><%= i.daysInStatus %></span></td>
            <td><span class="stuck-priority stuck-priority-<%= i.priorityLevel %>" title="<%= i.priorityName %>"><%= i.priorityLevel %></span></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <% } else { %>
    <p class="digest-empty">None.</p>
    <% } %>
    </div>
  </section>

  <section class="digest-section digest-section-collapsible" data-section="completed">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="completed">Completed this sprint (<%= digest.progress.count %>)</button></h2>
    <div class="digest-section-body">
    <% if (digest.progress.issues && digest.progress.issues.length > 0) { %>
    <table class="digest-table digest-table-people">
      <thead><tr><th class="sortable">Key <span class="sort-indicator"></span></th><th class="sortable">Assignee <span class="sort-indicator"></span></th><th class="sortable">Summary <span class="sort-indicator"></span></th><th class="sortable">Issue type <span class="sort-indicator"></span></th></tr></thead>
      <tbody>
        <% digest.progress.issues.forEach(issue => { %>
          <tr>
            <td class="digest-cell-key"><a href="<%= issue.link %>" target="_blank"><%= issue.key %></a></td>
            <td class="digest-cell-avatar-name"><% if (issue.avatarUrl) { %><img class="digest-avatar" src="<%= issue.avatarUrl %>" alt="" width="20" height="20" /><% } %><%= issue.assigneeShort %></td>
            <td><%= issue.summary.slice(0, 50) %><%= issue.summary.length > 50 ? '…' : '' %></td>
            <td><span class="issue-type-badge <%= (issue.issueType || '').toLowerCase().replace(/-/g, '') %>"><%= issue.issueType %></span></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <% } %>
    </div>
  </section>

  <section class="digest-section digest-section-collapsible" id="section-incomplete" data-section="incomplete">
    <h2 class="digest-section-header"><button type="button" class="digest-section-toggle" aria-expanded="true" data-section="incomplete">Carry Forward / Incomplete (<%= digest.incomplete.total %>)</button></h2>
    <div class="digest-section-body">
    <% if (digest.incomplete && digest.incomplete.incomplete && digest.incomplete.incomplete.length > 0) { %>
    <table class="digest-table digest-table-people">
      <thead><tr><th class="sortable">Key <span class="sort-indicator"></span></th><th class="sortable">Assignee <span class="sort-indicator"></span></th><th class="sortable">Summary <span class="sort-indicator"></span></th><th class="sortable">Status <span class="sort-indicator"></span></th><th class="sortable">Issue type <span class="sort-indicator"></span></th></tr></thead>
      <tbody>
        <% digest.incomplete.incomplete.forEach(i => { %>
          <tr>
            <td class="digest-cell-key"><a href="<%= i.link %>" target="_blank"><%= i.key %></a></td>
            <td class="digest-cell-avatar-name"><% if (i.avatarUrl) { %><img class="digest-avatar" src="<%= i.avatarUrl %>" alt="" width="20" height="20" /><% } %><%= i.assigneeShort %></td>
            <td><%= i.summary %></td>
            <td><%= i.status %></td>
            <td><span class="issue-type-badge <%= (i.issueType || '').toLowerCase().replace(/-/g, '') %>"><%= i.issueType %></span></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <% } else { %>
    <p class="digest-empty">None.</p>
    <% } %>
    </div>
  </section>

  <% /* Scope / velocity stats and bar are now inside Retro notes section above */ %>
  <% /* Backlog section commented out – not actionable for retro */ %>

  <% if (false && digest.pr) { /* PR section commented out */ %>
  <section class="digest-section">
    <h2>Pull requests</h2>
    <ul class="digest-pr-bullets">
      <li>Open: <strong><%= digest.pr.total %></strong></li>
      <li>Over <%= digest.prOpenDaysThreshold || 5 %> days: <strong><%= digest.pr.openOver5Days %></strong></li>
      <li>No reviewers: <strong><%= digest.pr.noReviewers %></strong></li>
    </ul>
    <p><a href="/pr">Full PR report</a></p>
  </section>
  <% } %>

</div>
